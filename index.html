<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Petal Chain - The Market</title>
    
    <link rel="icon" type="image/x-icon" href="logo/petalchainlogo.png">
    <link rel="apple-touch-icon" href="https://via.placeholder.com/192/000000/FFFFFF?text=PC">
    <meta name="theme-color" content="#000000">

    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        body { font-family: 'Inter', sans-serif; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        select { border-radius: 0; appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1em; }
    </style>
</head>
<body class="bg-white text-black min-h-screen flex flex-col" x-data="marketStore()" x-init="init()" x-cloak>

    <div x-show="showInstallPrompt" class="fixed top-20 left-4 right-4 z-[200] bg-black text-white p-5 border-2 border-white shadow-2xl" x-transition>
        <div class="flex justify-between items-start">
            <div class="flex gap-3">
                <div class="w-10 h-10 bg-white text-black flex items-center justify-center font-black">PC</div>
                <div>
                    <p class="font-black text-sm uppercase italic">Install Market App</p>
                    <p class="text-[10px] opacity-80 mt-1">Add Petal Chain to your home screen for a faster shopping experience.</p>
                </div>
            </div>
            <button @click="showInstallPrompt = false" class="text-xl font-bold px-2">×</button>
        </div>
        <button @click="triggerInstall()" class="mt-4 w-full bg-white text-black py-3 text-xs font-black uppercase tracking-widest hover:bg-gray-200 transition">
            Install / Got It
        </button>
    </div>

    <nav class="border-b-2 border-black sticky top-0 bg-white z-50 p-4 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <div class="w-10 h-10 bg-black text-white flex items-center justify-center font-black rounded-sm italic border border-white">PC</div>
            <span class="font-black text-xl tracking-tighter uppercase">Petal Chain</span>
        </div>
        <button @click="cartOpen = true" class="border-2 border-black px-4 py-1 font-bold hover:bg-black hover:text-white transition">
            CART [<span class="text-red-600" x-text="cart.length"></span>]
        </button>
    </nav>

    <div class="py-10 border-b border-black text-center px-4 bg-white">
        <h2 class="text-4xl font-black uppercase mb-1">The Market</h2>
        <p class="text-[10px] tracking-[0.2em] font-bold uppercase text-gray-400 italic">Add items to the cart for instant delivery.</p>
    </div>

    <div class="fixed bottom-10 left-0 right-0 z-[120] flex justify-center pointer-events-none">
        <template x-if="showToast">
            <div x-transition class="bg-black text-white px-6 py-3 font-black uppercase text-xs border-2 border-white shadow-xl pointer-events-auto">
                Item added to cart
            </div>
        </template>
    </div>

    <section class="p-4 border-b border-black space-y-4 sticky top-[74px] bg-white z-40">
        <input type="text" x-model="search" placeholder="SEARCH PRODUCTS..." 
               class="w-full border-2 border-black p-3 focus:outline-none placeholder-gray-400 font-bold uppercase text-sm">
        <div class="flex gap-2 overflow-x-auto no-scrollbar">
            <select x-model="filterStore" class="border-2 border-black p-2 text-[10px] font-black uppercase bg-white pr-8">
                <option value="">ALL STORES</option>
                <template x-for="s in Array.from(new Set(products.map(p => p.store)))">
                    <option :value="s" x-text="s"></option>
                </template>
            </select>
            <button @click="onlySales = !onlySales" 
                    :class="onlySales ? 'bg-black text-white' : 'bg-white text-black'"
                    class="border-2 border-black px-4 py-2 text-[10px] font-black uppercase">
                DISCOUNTS
            </button>
        </div>
    </section>

    <main class="p-4 grid-2 flex-grow">
        <template x-for="product in filteredProducts()" :key="product.id">
            <div class="border-2 border-black flex flex-col p-2 bg-white">
                <div class="relative cursor-pointer border-b border-black mb-2 overflow-hidden" @click="viewImage = product.image">
                    <img :src="product.image" class="w-full aspect-square object-cover transition duration-300 hover:scale-105">
                </div>
                <div class="flex-grow">
                    <p class="text-[9px] font-bold text-gray-400 uppercase" x-text="product.store"></p>
                    <h3 class="font-black text-xs uppercase h-8 overflow-hidden" x-text="product.name"></h3>
                    <p class="text-lg font-black mt-1" x-text="'R' + product.price"></p>
                </div>
                <div class="mt-3 space-y-2">
                    <select x-model="product.orderQty" class="w-full border-2 border-black p-1 text-xs font-bold bg-white pr-6">
                        <template x-for="n in 12">
                            <option :value="n" x-text="'Quantity: ' + n"></option>
                        </template>
                    </select>
                    <button @click="addToCart(product)" class="w-full bg-black text-white py-2 text-[10px] font-black uppercase border border-black hover:bg-white hover:text-black transition">
                        ADD TO CART
                    </button>
                </div>
            </div>
        </template>
    </main>

    <div x-show="cartOpen" class="fixed inset-0 z-[100] bg-black bg-opacity-80 flex justify-end" x-transition>
        <div class="bg-white w-full max-w-md h-full p-6 flex flex-col shadow-2xl" @click.away="cartOpen = false">
            <div class="flex justify-between items-center border-b-4 border-black pb-4">
                <h2 class="text-2xl font-black uppercase italic">CART</h2>
                <button @click="cartOpen = false" class="text-4xl font-black leading-none">×</button>
            </div>
            <div class="flex-1 overflow-y-auto py-4">
                <template x-for="item in cart" :key="item.id">
                    <div class="flex justify-between items-center border-b border-gray-100 py-3">
                        <div>
                            <p class="font-black uppercase text-sm" x-text="item.name"></p>
                            <p class="text-[10px] font-bold text-gray-500" x-text="'Qty: ' + item.qty + ' | ' + item.store"></p>
                        </div>
                        <button @click="removeFromCart(item.id)" class="text-[9px] font-black underline uppercase">Remove</button>
                    </div>
                </template>
            </div>
            <div class="border-t-4 border-black pt-4">
                <div class="flex justify-between text-2xl font-black mb-4">
                    <span>TOTAL</span><span x-text="'R' + (subtotal() + 3)"></span>
                </div>
                <button @click="checkout()" class="w-full bg-black text-white py-4 font-black text-sm uppercase border-2 border-black">
                    CONFIRM VIA WHATSAPP
                </button>
            </div>
        </div>
    </div>

    <footer class="bg-black text-white p-12 mt-auto border-t-4 border-black">
        <div class="flex flex-col items-center gap-6 text-center">
            <div class="w-12 h-12 border-2 border-white flex items-center justify-center text-xl font-black italic">PC</div>
            <p class="font-black uppercase tracking-widest text-sm">Petal Chain - The Market</p>
            <div class="grid grid-cols-2 gap-10 text-[10px] uppercase font-bold opacity-80">
                <div class="space-y-2">
                    <a href="#" class="block underline">Privacy Policy</a>
                    <a href="#" class="block underline">Terms & Conditions</a>
                </div>
                <div class="space-y-2 text-right">
                    <p>market@petalchain.co.za</p>
                    <p>WA: 0646575290</p>
                </div>
            </div>
        </div>
    </footer>

    <script>
        function marketStore() {
            return {
                cartOpen: false,
                viewImage: null,
                showToast: false,
                showInstallPrompt: false,
                deferredPrompt: null,
                search: '',
                filterStore: '',
                onlySales: false,
                cart: [],
                products: [
                    { id: 1, name: "Sunflower Oil 2L", store: "Checkers", price: 75, discount: true, image: "https://images.unsplash.com/photo-1474979266404-7eaacbcd87c5?w=500", orderQty: 1, link: "petalchain.co.za/oil" },
                    { id: 2, name: "White Bread Sliced", store: "Pick n Pay", price: 18, discount: false, image: "https://images.unsplash.com/photo-1509440159596-0249088772ff?w=500", orderQty: 1, link: "petalchain.co.za/bread" },
                    { id: 3, name: "Red Apples 1.5kg", store: "Woolworths", price: 35, discount: true, image: "https://images.unsplash.com/photo-1567306226416-28f0efdc88ce?w=500", orderQty: 1, link: "petalchain.co.za/apples" },
                    { id: 4, name: "Large Eggs 18pk", store: "Checkers", price: 58, discount: false, image: "https://images.unsplash.com/photo-1516448620398-c5f44bf9f441?w=500", orderQty: 1, link: "petalchain.co.za/eggs" }
                ],
                init() {
                    // Capture the browser's install request
                    window.addEventListener('beforeinstallprompt', (e) => {
                        e.preventDefault();
                        this.deferredPrompt = e;
                        this.showInstallPrompt = true;
                    });
                    
                    // Fallback: If browser doesn't support the prompt, show anyway after 5s
                    setTimeout(() => { if(!this.deferredPrompt) this.showInstallPrompt = true; }, 5000);
                },
                triggerInstall() {
                    if (this.deferredPrompt) {
                        this.deferredPrompt.prompt();
                        this.deferredPrompt.userChoice.then((choice) => {
                            if (choice.outcome === 'accepted') console.log('User installed');
                            this.showInstallPrompt = false;
                        });
                    } else {
                        // Fallback for iPhones/Safari which don't support beforeinstallprompt
                        alert("To save: Tap the 'Share' icon (square with arrow) and select 'Add to Home Screen'.");
                        this.showInstallPrompt = false;
                    }
                },
                filteredProducts() {
                    return this.products.filter(p => {
                        return p.name.toLowerCase().includes(this.search.toLowerCase()) &&
                               (this.filterStore === '' || p.store === this.filterStore) &&
                               (!this.onlySales || p.discount);
                    });
                },
                addToCart(product) {
                    let item = this.cart.find(i => i.id === product.id);
                    if (item) {
                        item.qty = parseInt(item.qty) + parseInt(product.orderQty);
                    } else {
                        this.cart.push({ ...product, qty: parseInt(product.orderQty) });
                    }
                    product.orderQty = 1;
                    this.showToast = true;
                    setTimeout(() => { this.showToast = false; }, 2000);
                },
                subtotal() { return this.cart.reduce((sum, item) => sum + (item.price * item.qty), 0); },
                checkout() {
                    navigator.geolocation.getCurrentPosition((pos) => {
                        const message = `*ORDER*%0AItems: ${this.cart.length}%0A*Total: R${this.subtotal() + 3}*%0AMaps: http://maps.google.com/?q=${pos.coords.latitude},${pos.coords.longitude}`;
                        window.open(`https://wa.me/27646575290?text=${message}`, '_blank');
                    });
                }
            }
        }
    </script>
</body>
</html>
